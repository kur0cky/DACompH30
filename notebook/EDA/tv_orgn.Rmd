---
title: "EDA about orgn_program"
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 2
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
md_extensions: -ascii_identifiers
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warnings = FALSE,
                      cache = TRUE)
```

```{r import, cache=FALSE}
library(tidyverse)
library(lubridate)
library(dbplyr)
library(dbplot)
library(RPostgreSQL)
library(ggforce)

theme_set(theme_bw(base_family = "HiraKakuPro-W3"))
```

```{r connect, cache=FALSE}
conn <- dbConnect(PostgreSQL(),
                  host = scan("connection.txt", what = character())[1],
                  port = scan("connection.txt", what = character())[2], 
                  dbname = scan("connection.txt", what = character())[3], 
                  user = scan("connection.txt", what = character())[4], 
                  password = scan("connection.txt", what = character())[5])

orgn <- conn %>% 
  tbl(from = dbplyr::in_schema("edit", "tv_orgn_program_2")) 
tmp <- conn %>% 
  tbl(from = dbplyr::in_schema("processed", "tv_orgn_p_cv")) 
program <- conn %>% 
  tbl(from = dbplyr::in_schema("processed", "tv_program")) 
ban <- conn %>% 
  tbl(from = dbplyr::in_schema("processed", "bancluster_mst")) 
ban1 <- conn %>% 
  tbl(from = dbplyr::in_schema("sub_mst", "ban_code1_mst")) 
```


# introduction

テレビ接触の傾向をさぐる  

**TV接触おさらい**
タイムシフト or リアルタイムを問わず，再生された番組の放送局と放送日時のレコード．  
さらに，なんの番組を見ていたかに対応するorgn_programを稗田さんに作成していただいた

クラスタ（VR区分）との繋がりも探っていけたら良い

**注意点**  
processed.tv_orgn_p_cvが接触した放送部分のレコードであるのに対し  
edit.orgn_programでは番組を跨いだ視聴が分割されるので，注意が必要

# count records{.tabset}

## processed.tv_orgn_p_cv

- 細切れに分けて接触した場合はレコードが増える
- ぶっ通しで複数番組見た場合はレコードが一つになる
- リアルタイムがタイムシフトの約2倍ある

```{r count_records_processed.orgn}
tmp %>% 
  count(data_agg_type) %>% 
  arrange(data_agg_type) %>% 
  ggplot(aes(factor(data_agg_type), n))+
  geom_bar(stat = "identity", colour = "blue", fill = "skyblue")+
  geom_text(aes(label = n, y = n*0.9))+
  labs(x = "リアルタイム, タイムシフト")
```


## edit.orgn_program_2

- 番組との回数
- ぶっ通しで複数番組見た場合が切り分けられている
    - 当然，タイムシフトは番組ごとに予約して見ているはず
    - よってリアルタイムの方が爆発的に増える（約1.5倍）
    - タイムシフト視聴の方はほとんど変わらない（6万件増える）

```{r count_records_edit.orgn_program}
orgn %>% 
  count(data_agg_type) %>% 
  arrange(data_agg_type) %>% 
  ggplot(aes(factor(data_agg_type), n))+
  geom_bar(stat = "identity", colour = "blue", fill = "skyblue")+
  geom_text(aes(label = n, y = n*0.9))+
  labs(x = "リアルタイム, タイムシフト")
```


## per ban_code1

- ドラマは録画して見る傾向が強い，などの傾向がありそう

```{r barplot_records_per_ban_code1}
orgn %>% 
  left_join(program, by = c("program_code", "program_start_time")) %>% 
  count(ban_code1, data_agg_type) %>% 
  ungroup() %>% 
  left_join(ban1, by = "ban_code1") %>% 
  ggplot(aes(ban_code1_naiyou, n))+
  geom_bar(stat = "identity", colour = "blue", fill = "skyblue")+
  coord_flip()+
  facet_wrap(~data_agg_type, scale = "free")
```

続いて全体に占めるタイムシフトの比率を見てみる

- ドラマ，映画，アニメはタイムシフトで見る傾向が顕著
- 次点で音楽，娯楽番組
- 逆に報道，教育・教養・実用・スポーツはリアルタイムで見る傾向

```{r cum_barplot_records_per_ban_code1}
orgn %>% 
  left_join(program, by = c("program_code", "program_start_time")) %>% 
  count(ban_code1, data_agg_type) %>% 
  left_join(ban1, by = "ban_code1") %>% 
  group_by(ban_code1_naiyou) %>% 
  mutate(rate = n / sum(n, na.rm=TRUE)) %>% 
  filter(data_agg_type == 9) %>% 
  ggplot(aes(ban_code1_naiyou, rate))+
  geom_bar(stat = "identity", colour = "blue", fill = "skyblue")+
  coord_flip()
```

## count records per program

```{r barplot_records_per_program}
orgn %>% 
  select(house_num, program_start_time, station_code, data_agg_type) %>% 
  left_join(program, by = c("program_start_time", "station_code")) %>% 
  count(ban_code1, program_code, program_name) %>% 
  ungroup() %>% 
  group_by(ban_code1) %>% 
  arrange(desc(n)) %>% 
  collect() %>% 
  slice(1:5) %>% 
  ungroup() %>% 
  left_join(ban1, by = "ban_code1") %>% 
  ggplot(aes(program_name, n))+
  geom_bar(stat = "identity")+
  coord_flip()+
  facet_wrap(~ban_code1_naiyou, scale="free")
```





# watch time

どのぐらいの時間番組を見たか
接触分(watch_time)ごとのレコード数をプロットした  
orgn_programを使用

- 指数分布に近い
- 2380万レコードのうち，500万レコードが1分以内
- チャンネルを目まぐるしく変えている感じ？
- 60分, 30分, 15分, 10分, 5分のスパイクが目立つ
- 番組を最初から最後まで見ているためだろうか？

```{r}
watch_time <- dbGetQuery(conn, "
SELECT
  COUNT (*),
  EXTRACT(hour from watch_time ) * 60 +
  EXTRACT(minute from watch_time)  as watch_time
FROM
  edit.tv_orgn_program
GROUP BY
  EXTRACT(hour from watch_time ) * 60 +
  EXTRACT(minute from watch_time) 
")
watch_time %>% 
  arrange(watch_time) %>% 
  ggplot(aes(watch_time, count))+
  geom_bar(stat = "identity")+
  facet_zoom(x = watch_time < 65)

watch_time %>% 
  arrange(watch_time) %>% 
  filter(watch_time != 0) %>% 
  ggplot(aes(watch_time, count))+
  geom_bar(stat = "identity")+
  facet_zoom(x = watch_time < 65)+
  labs(title = "watch_time != 0")
```


# watch time（watch_time = program_time）{.tabset}


## sum watch_time per house

- 10000時間ぐらいでピーク

```{r}
watch_time_per_house <- dbGetQuery(conn, "
SELECT
  house_num,
  COUNT (*),
  sum(
    EXTRACT(hour from watch_time ) * 60 +
    EXTRACT(minute from watch_time)
  ) as watch_time
FROM
  edit.tv_orgn_program
WHERE
  EXTRACT(hour from watch_time ) * 60 +
  EXTRACT(minute from watch_time) != 0
GROUP BY
  house_num
") %>% 
  arrange(house_num) %>% 
  as_tibble()
watch_time_per_house %>% 
  ggplot(aes(watch_time))+
  geom_histogram(bins = 50)+
  facet_zoom(x = watch_time < 200000)+
  labs(x = "テレビ接触時間（分）", y = "世帯数")
```

## mean watch_time per house

- 15~20分ぐらいでピーク
- 

```{r}
watch_time_per_house %>% 
  as_tibble() %>% 
  mutate(mean_watch_time = watch_time / count) %>% 
  ggplot(aes(mean_watch_time, ..density..))+
  geom_histogram(bins=50, fill="skyblue")+
  geom_density()
  
```

